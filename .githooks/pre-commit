#!/usr/bin/env bash
set -euo pipefail

# Run pre-commit to validate staged files using repo-local caches.
export UV_CACHE_DIR="${UV_CACHE_DIR:-$PWD/.uv-cache}"
export UV_TOOL_DIR="${UV_TOOL_DIR:-$PWD/.uv-tools}"

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

echo "Running pre-commit hooks..."
if ! uv run --frozen pre-commit run --hook-stage commit; then
  STATUS=$?
  echo "$STAGED_FILES" | while read -r file; do
    if [ -n "$file" ] && [ -f "$file" ]; then
      git add "$file"
    fi
  done
  exit $STATUS
fi

echo "$STAGED_FILES" | while read -r file; do
  if [ -n "$file" ] && [ -f "$file" ]; then
    git add "$file"
  fi
done
