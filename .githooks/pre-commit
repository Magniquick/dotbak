#!/usr/bin/env bash
set -euo pipefail

# Run Black and isort to auto-format staged Python files before commit using repo-local caches.
export UV_CACHE_DIR="${UV_CACHE_DIR:-$PWD/.uv-cache}"
export UV_TOOL_DIR="${UV_TOOL_DIR:-$PWD/.uv-tools}"

PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PY_FILES" ]; then
  exit 0
fi

echo "Sorting imports with isort..."
uv run --frozen isort $PY_FILES

echo "Formatting staged Python files with Black..."
uv run --frozen black $PY_FILES

# Re-stage any files Black rewrote.
echo "$PY_FILES" | while read -r file; do
  if [ -n "$file" ] && [ -f "$file" ]; then
    git add "$file"
  fi
done
